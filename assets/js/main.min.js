/* MARIDAV CI — Enhancements (no external deps) */
(function(){
  function getRoot(){
    try{
      var scr=[].slice.call(document.scripts).find(function(s){return (s.src||'').indexOf('assets/js/main.min.js')!==-1});
      if(!scr||!scr.src) return '';
      return scr.src.replace(/assets\/js\/main\.min\.js.*$/,'');
    }catch(e){return ''}
  }
  var ROOT=getRoot();
  try {
    // Inject manifest (PWA)
    var m=document.createElement('link');m.rel='manifest';m.href= ROOT + 'assets/manifest.webmanifest';document.head.appendChild(m);
  } catch(e){}

  // Register Service Worker (best-effort)
  if('serviceWorker' in navigator){
    window.addEventListener('load',function(){
      try{ navigator.serviceWorker.register(ROOT + 'assets/js/sw.js').catch(function(){}); }catch(e){}
    });
  }

  // Ensure Bootstrap 5 bundle for navbar collapse (best-effort)
  (function ensureBS(){
    try{ if(window.bootstrap && window.bootstrap.Collapse) return; }catch(e){}
    var s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
    s.defer=true; document.head.appendChild(s);
  })();

  // Floating WhatsApp
  function addWhatsApp(){
    if(document.querySelector('.floating-whatsapp')) return;
    var a=document.createElement('a');
    a.href='https://api.whatsapp.com/send?phone=+2250574648888';
    a.className='floating-whatsapp';
    a.target='_blank';
    a.setAttribute('aria-label','Discuter avec MARIDAV sur WhatsApp');
    a.innerHTML='<img alt="" src="'+ ROOT +'maridav_ci_image/logo/whatsapp-logo-contact-maridav.png"/> <span>WhatsApp</span>';
    a.addEventListener('click',function(){track('whatsapp_click',{href:a.href})});
    document.body.appendChild(a);
  }

  // Premium Header injection (modern navbar)
  function injectPremiumHeader(){
    if(document.querySelector('.premium-header')) return;
    document.body.classList.add('premium-active');
    var header=document.createElement('header');
    header.className='premium-header sticky-top';
    header.setAttribute('role','banner');
    header.innerHTML='\
      <nav class="navbar navbar-expand-lg navbar-premium" aria-label="Navigation principale">\
        <div class="container">\
          <a class="navbar-brand" href="index.html" aria-label="MARIDAV CI">\
            <img alt="MARIDAV CI" src="'+ ROOT +'maridav_ci_image/logo/logo_maridav_ci.png"/>\
          </a>\
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navPremium" aria-controls="navPremium" aria-expanded="false" aria-label="Menu">\
            <span class="navbar-toggler-icon"></span>\
          </button>\
          <div class="collapse navbar-collapse" id="navPremium">\
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">\
              <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>\
              <li class="nav-item dropdown">\
                <button class="nav-link dropdown-toggle" id="navSolutions" type="button" data-bs-toggle="dropdown" aria-expanded="false">Solutions</button>\
                <ul class="dropdown-menu" aria-labelledby="navSolutions">\
                  <li><a class="dropdown-item" href="volailles.html">Volailles</a></li>\
                  <li><a class="dropdown-item" href="porcins_maridav_ci.html">Porcs</a></li>\
                  <li><a class="dropdown-item" href="pisciculture_maridav_ci.html">Poissons</a></li>\
                  <li><a class="dropdown-item" href="biosecurite_maridav_ci.html">Biosécurité</a></li>\
                </ul>\
              </li>\
              <li class="nav-item dropdown">\
                <button class="nav-link dropdown-toggle" id="navResources" type="button" data-bs-toggle="dropdown" aria-expanded="false">Ressources</button>\
                <ul class="dropdown-menu" aria-labelledby="navResources">\
                  <li><a class="dropdown-item" href="a-propos.html">À propos de nous</a></li>\
                  <li><a class="dropdown-item" href="blog_maridav_ci.html">Blog</a></li>\
                  <li><a class="dropdown-item" href="ressources/">Documentations techniques</a></li>\
                </ul>\
              </li>\
              <li class="nav-item"><a class="nav-link" href="distributeurs_maridav.html">Points de vente</a></li>\
            </ul>\
            <div class="nav-meta d-lg-flex align-items-center gap-2 ms-lg-3">\
              <a class="meta-pill" href="tel:002252721353242"><i class="fa fa-phone"></i><span>(+225) 27 21 35 32 42</span></a>\
              <a class="meta-pill" href="https://api.whatsapp.com/send?phone=+2250574648888" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i><span>05 74 64 88 88</span></a>\
            </div>\
            <div class="nav-cta d-flex flex-column flex-lg-row gap-2 ms-lg-3">\
              <a class="btn btn-brand btn-sm" href="contact.html">Demander un devis</a>\
            </div>\
          </div>\
        </div>\
      </nav>';
    document.body.prepend(header);
  }

  // Premium Footer injection
  function injectPremiumFooter(){
    if(document.querySelector('.footer-premium')) return;
    var f=document.createElement('footer');
    var year=new Date().getFullYear();
    f.className='footer-premium';
    f.setAttribute('role','contentinfo');
    f.innerHTML='\
      <div class="footer-top">\
        <div class="container">\
          <div class="row g-4">\
            <div class="col-12 col-lg-4">\
              <div class="brand"><img src="'+ ROOT +'maridav_ci_image/logo/logo_maridav_ci.png" alt="MARIDAV"><span>MARIDAV Côte d\'Ivoire<small>Nutrition & Santé Animales</small></span></div>\
              <p class="mt-3 small">Formulations tropicalisées, appui technique terrain et biosécurité pour volailles, porcs et poissons. Livraison nationale et appui technique présent sur le terrain.</p>\
            </div>\
            <div class="col-6 col-lg-2">\
              <h6>Solutions</h6>\
              <ul class="list-unstyled m-0">\
                <li><a class="small-link" href="volailles.html">Volailles</a></li>\
                <li><a class="small-link" href="porcins_maridav_ci.html">Porcs</a></li>\
                <li><a class="small-link" href="pisciculture_maridav_ci.html">Poissons</a></li>\
                <li><a class="small-link" href="biosecurite_maridav_ci.html">Biosécurité</a></li>\
              </ul>\
            </div>\
            <div class="col-6 col-lg-3">\
              <h6>Ressources</h6>\
              <ul class="list-unstyled m-0">\
                <li><a class="small-link" href="blog_maridav_ci.html">Guides & articles</a></li>\
                <li><a class="small-link" href="ressources/">Fiches techniques & PDF</a></li>\
                <li><a class="small-link" href="distributeurs_maridav.html">Points de vente</a></li>\
                <li><a class="small-link" href="contact.html">Demander un devis</a></li>\
              </ul>\
            </div>\
            <div class="col-12 col-lg-3">\
              <h6>Contact</h6>\
              <ul class="list-unstyled footer-contact">\
                <li><i class="fa fa-map-marker"></i><span>Marcory Zone 4C Biétry, 34 Rue Alex Flemming – Abidjan</span></li>\
                <li><i class="fa fa-clock-o"></i><span>Lundi à Vendredi : 08h – 18h<br>Samedi : 08h – 13h</span></li>\
              </ul>\
              <div class="d-flex flex-column gap-2 mt-3">\
                <a class="small-link" href="mailto:info@maridav.ci"><i class="fa fa-envelope"></i> info@maridav.ci</a>\
                <a class="small-link" href="tel:002252721353242"><i class="fa fa-phone"></i> (+225) 27 21 35 32 42</a>\
                <a class="btn btn-brand btn-sm" href="#lead" data-open-lead>Parler à un expert</a>\
              </div>\
            </div>\
          </div>\
        </div>\
      </div>\
      <div class="footer-bottom">\
        <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">\
          <p class="mb-0 small">© '+year+' MARIDAV Côte d\'Ivoire — Nutrition & santé animales.</p>\
          <div class="footer-social">\
            <a href="https://www.facebook.com/MaridavCI/" target="_blank" rel="noopener" aria-label="Facebook"><i class="fab fa-facebook"></i></a>\
            <a href="https://ci.linkedin.com/company/maridav-ci" target="_blank" rel="noopener" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>\
          </div>\
        </div>\
      </div>';
    document.body.appendChild(f);
  }

  // Dropdown fallback (when Bootstrap JS not ready)
  function enableNavDropdownFallback(){
    var nav=document.querySelector('.navbar-premium');
    if(!nav) return;
    var toggles=nav.querySelectorAll('.dropdown-toggle');
    if(!toggles.length) return;

    function showDropdown(parent){
      if(!parent) return;
      var toggle=parent.querySelector('.dropdown-toggle');
      var menu=parent.querySelector('.dropdown-menu');
      parent.classList.add('show');
      if(menu) menu.classList.add('show');
      if(toggle) toggle.setAttribute('aria-expanded','true');
    }
    function hideDropdown(parent){
      if(!parent) return;
      var toggle=parent.querySelector('.dropdown-toggle');
      var menu=parent.querySelector('.dropdown-menu');
      parent.classList.remove('show');
      if(menu) menu.classList.remove('show');
      if(toggle) toggle.setAttribute('aria-expanded','false');
    }
    function closeAll(except){
      toggles.forEach(function(toggle){
        var parent=toggle.closest('.dropdown');
        if(!parent) return;
        if(except && parent===except) return;
        hideDropdown(parent);
      });
    }

    toggles.forEach(function(toggle){
      var parent=toggle.closest('.dropdown');
      toggle.addEventListener('click', function(e){
        e.preventDefault();
        var isOpen=parent && parent.classList.contains('show');
        closeAll();
        if(parent){
          if(isOpen){ hideDropdown(parent); }
          else{ showDropdown(parent); }
        }
      });
      if(parent){
        var hoverTimeout;
        parent.addEventListener('mouseenter', function(){
          if(window.matchMedia('(min-width: 992px)').matches){
            clearTimeout(hoverTimeout);
            closeAll(parent);
            showDropdown(parent);
          }
        });
        parent.addEventListener('mouseleave', function(){
          if(window.matchMedia('(min-width: 992px)').matches){
            hoverTimeout=setTimeout(function(){ hideDropdown(parent); },120);
          }
        });
      }
    });
    document.addEventListener('click', function(e){
      var current=e.target.closest('.dropdown');
      if(!current || !nav.contains(current)){ closeAll(); }
    });
  }

  // Sticky product CTA bar (if product page)
  function addProductCTA(){
    if(document.querySelector('.cta-sticky')) return;
    var hasProduct = !!document.querySelector('.product-info, .product-details');
    if(!hasProduct) return;
    var wrap=document.createElement('div');wrap.className='cta-sticky';
    wrap.innerHTML='<div class="cta-wrap">\
      <a class="btn btn-brand" href="#lead-modal" data-open-lead>Demander un devis</a>\
      <a class="btn btn-outline-brand" target="_blank" href="https://api.whatsapp.com/send?phone=+2250574648888">Parler à un technicien</a>\
      <a class="btn btn-outline-brand" href="#ressources" role="button">Fiche technique</a>\
    </div>';
    wrap.addEventListener('click',function(e){
      var t=e.target.closest('a');
      if(!t) return;
      if(t.hasAttribute('data-open-lead')){
        e.preventDefault(); openLeadModal();
        track('lead_open',{});
      }
      if(t.href && t.href.startsWith('https://api.whatsapp.com')){
        track('whatsapp_click',{href:t.href});
      }
    });
    document.body.appendChild(wrap);
  }

  // Lead modal (lightweight)
  function openLeadModal(){
    var id='lead-modal';
    var modal=document.getElementById(id);
    if(!modal){
      modal=document.createElement('div');
      modal.id=id; modal.setAttribute('role','dialog'); modal.setAttribute('aria-modal','true');
      modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,.5)'; modal.style.zIndex='1100';
      modal.innerHTML='\
      <div style="max-width:720px;margin:6vh auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden">\
        <div class="p-3" style="background:var(--brand-primary);color:#fff"><strong>Demander un devis</strong></div>\
        <div class="p-3">\
          <form id="lead-form" class="needs-validation" novalidate>\
            <div class="row">\
              <div class="col-12 col-md-6 mb-2"><label class="form-label">Nom et Prénom</label><input required name="name" class="form-control" placeholder="Ex: Kouadio Y."/></div>\
              <div class="col-12 col-md-6 mb-2"><label class="form-label">Téléphone</label><input required name="phone" class="form-control" placeholder="Ex: 05 74 64 88 88"/></div>\
              <div class="col-12 col-md-6 mb-2"><label class="form-label">Espèce</label>\
                <select required name="species" class="form-control">\
                  <option value="">Choisir…</option>\
                  <option>Volailles</option><option>Porcs</option><option>Poissons</option>\
                </select></div>\
              <div class="col-12 col-md-6 mb-2"><label class="form-label">Produit/Gamme</label><input name="product" class="form-control" placeholder="Ex: Aliment Chair Croissance"/></div>\
              <div class="col-12 mb-2"><label class="form-label">Message</label><textarea name="message" rows="3" class="form-control" placeholder="Besoin, volumes estimés, délais…"></textarea></div>\
            </div>\
            <div class="d-flex gap-2 justify-content-end mt-2">\
              <button type="button" class="btn btn-outline-brand" data-close>Fermer</button>\
              <button type="submit" class="btn btn-brand">Envoyer</button>\
            </div>\
          </form>\
        </div>\
      </div>';
      modal.addEventListener('click',function(e){ if(e.target===modal || e.target.hasAttribute('data-close')) modal.remove(); });
      var formHandler=function(e){
        e.preventDefault();
        var f=e.target; var data={};
        Array.from(new FormData(f).entries()).forEach(function(kv){data[kv[0]]=kv[1]});
        track('lead_submit',data);
        alert('Merci, votre demande a été envoyée. Un technicien vous recontacte.');
        modal.remove();
      };
      setTimeout(function(){ var f=modal.querySelector('#lead-form'); if(f){ f.addEventListener('submit',formHandler); } },0);
      document.body.appendChild(modal);
    }
  }

  // Lazy-load images + basic alt fallback
  function improveImages(){
    document.querySelectorAll('img:not([loading])').forEach(function(img){ img.loading='lazy'; });
    document.querySelectorAll('img:not([alt])').forEach(function(img){ img.alt='Image - MARIDAV CI'; });
  }

  // Simple analytics dispatcher (to GA4/DTM later). For now: dataLayer + console
  function track(event, payload){
    try { window.dataLayer = window.dataLayer || []; window.dataLayer.push({event:event, payload:payload||{}}); } catch(e){}
    if(window && window.console){ console.log('[TRACK]', event, payload||{}); }
  }

  // SEO: inject Organization JSON-LD on homepage
  function addOrganizationJSONLD(){
    if(document.querySelector('script[data-schema="organization"]')) return;
    var onHome = /index(\-2)?\.html?$/.test(location.pathname) || document.body.classList.contains('home');
    if(!onHome) return;
    var s=document.createElement('script'); s.type='application/ld+json'; s.dataset.schema='organization';
    var json={
      "@context":"https://schema.org",
      "@type":"Organization",
      "name":"MARIDAV Côte d'Ivoire",
      "url": location.href,
      "logo": ROOT + 'maridav_ci_image/logo/logo_maridav_ci.png',
      "sameAs":["https://www.facebook.com/MaridavCI/","https://ci.linkedin.com/company/maridav-ci"],
      "address":{"@type":"PostalAddress","streetAddress":"Marcory Zone 4C Biétry 34 Rue Alex Flemming","addressLocality":"Abidjan","postalCode":"09 BP 3643 Abidjan 09","addressCountry":"CI"},
      "contactPoint":[{"@type":"ContactPoint","telephone":"+225-27-21-35-32-42","contactType":"customer service","areaServed":"CI"}]
    };
    s.textContent=JSON.stringify(json); document.head.appendChild(s);
  }

  // SEO: inject basic Product JSON-LD (best-effort) on product pages
  function addProductJSONLD(){
    if(document.querySelector('script[data-schema="product"]')) return;
    var isProduct = !!document.querySelector('.product-info, .shop-details .product-details');
    if(!isProduct) return;
    var name = (document.querySelector('.product-info .title, .maridav-ci-title-one h3, h1, h2')||{}).textContent||'Produit MARIDAV';
    var img = (document.querySelector('.product-images img, .shop-details img')||{}).src || '';
    var s=document.createElement('script'); s.type='application/ld+json'; s.dataset.schema='product';
    var json={"@context":"https://schema.org","@type":"Product","name":name.trim(),"brand":{"@type":"Brand","name":"MARIDAV"},"image":img, "category":"Nutrition & Santé Animales"};
    s.textContent=JSON.stringify(json); document.head.appendChild(s);
  }

  // Accessibility: skip link
  function addSkipLink(){
    if(document.querySelector('.skip-link')) return;
    var a=document.createElement('a');a.href='#main';a.className='skip-link';a.textContent='Aller au contenu';
    document.body.prepend(a);
  }

  // Track tel: links
  function trackContacts(){
    document.querySelectorAll('a[href^="tel:"]').forEach(function(a){
      a.addEventListener('click',function(){track('call_click',{href:a.href})});
    });
  }

  // Init
  function init(){
    // Adjust hero CTA labels for small screens
    function adjustHeroCTALabel(){
      try{
        var primary=document.querySelector('.hero-premium .cta-row .btn.btn-brand');
        var w=window.innerWidth||document.documentElement.clientWidth;
        if(w<=576){
          if(primary){
            var txt=(primary.textContent||'').trim();
            if(!primary.dataset.fullLabel){ primary.dataset.fullLabel=txt; }
            if(txt.length>14){ primary.textContent='Nos Solutions'; }
          }
        } else {
          if(primary && primary.dataset.fullLabel){ primary.textContent=primary.dataset.fullLabel; delete primary.dataset.fullLabel; }
        }
      }catch(e){}
    }
    adjustHeroCTALabel();
    window.addEventListener('resize', function(){ try{ adjustHeroCTALabel(); }catch(e){} });

    // Fallback tabs for About card (works without Bootstrap JS)
    (function enableAboutTabsFallback(){
      try{
        var container=document.querySelector('.about-card');
        if(!container) return;
        var triggers=container.querySelectorAll('[data-bs-toggle="tab"]');
        if(!triggers.length) return;
        function activate(targetSel){
          // nav active
          container.querySelectorAll('.nav-link').forEach(function(l){ l.classList.remove('active'); });
          var btn = container.querySelector('[data-bs-target="'+targetSel+'"]');
          if(btn){ btn.classList.add('active'); }
          // panes
          container.querySelectorAll('.tab-pane').forEach(function(p){ p.classList.remove('active','show'); });
          var pane=container.querySelector(targetSel);
          if(pane){ pane.classList.add('active','show'); }
        }
        triggers.forEach(function(btn){
          btn.addEventListener('click', function(e){
            e.preventDefault();
            var target=btn.getAttribute('data-bs-target');
            // set hash sans scroll
            try{ var name=(target||'').replace('#tab-',''); history.replaceState(null,'','#'+name); }catch(err){}
            activate(target);
          });
        });
        // init via hash
        try{
          var h=(location.hash||'').replace('#','');
          if(h){ var t='#tab-'+h; if(container.querySelector(t)){ activate(t); } }
          window.addEventListener('hashchange', function(){
            var hh=(location.hash||'').replace('#',''); var tt='#tab-'+hh; if(container.querySelector(tt)){ activate(tt); }
          });
        }catch(err){}
      }catch(e){}
    })();

    // Add/normalize legacy menu link to À propos
    (function patchLegacyMenu(){
      try{
        // Normalize existing anchor-based link
        document.querySelectorAll('a[href="#a_propos"]').forEach(function(a){ a.setAttribute('href','a-propos.html'); });
        document.querySelectorAll('a[href="#contact"]').forEach(function(a){ a.setAttribute('href','contact.html'); });
        // If legacy mega menu exists, ensure À propos is present after Accueil
        var ul=document.querySelector('#mega-menu-holder > ul.clearfix');
        if(!ul) return;
        var has=false; ul.querySelectorAll('a').forEach(function(a){ if((a.textContent||'').toLowerCase().includes('propos')) has=true; });
        if(!has){
          var li=document.createElement('li'); li.className='';
          var a=document.createElement('a'); a.href='a-propos.html'; a.textContent='À propos';
          li.appendChild(a);
          var first=ul.querySelector('li');
          if(first && first.nextSibling){ ul.insertBefore(li, first.nextSibling); } else { ul.appendChild(li); }
        }
      }catch(e){}
    })();
    injectPremiumHeader();
    injectPremiumFooter();
    enableNavDropdownFallback();
    addWhatsApp();
    addProductCTA();
    improveImages();
    addOrganizationJSONLD();
    addProductJSONLD();
    addSkipLink();
    trackContacts();
    window.addEventListener('openLead', openLeadModal);
  }
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);} else {init();}
})();
